<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Forge API Reference (FAR)</title>

<script src="https://unpkg.com/remotestoragejs@1.2.3/release/remotestorage.js"></script>
<script src="https://unpkg.com/remotestorage-widget@1.7.0/build/widget.js"></script>

<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">

<style>
* {
	font-size: 1rem;
}
.block {
	display: block;
	margin: 10px 0;
}
.box {
	width: 100%;
	overflow-wrap: break-word;
}

h1, h2, h3 {
	margin: 5px 0;
	font-size: 1.5rem;
}

h3 {
	font-size: 1.2rem;
}
</style>

</head>
<body>

<h1>Forge API Reference (FAR)</h1>
<sub>Exploring data storage in forge repositories, ideally in browser-based apps.</sub>

<hr>

<h2>oauth</h2>

<p class="notice">Make sure <code id="0-config">this url</code> is registered in your as a redirect URI</p>

<h3>1: request token</h3>

<div id="1-link" class="box"></div>

<hr>

<h3>2: exchange token</h3>

<div id="2-post" class="box"></div>

<script>
const redirect_uri = location.href.split('?')[0].split('#')[0];
const forgejoDomain = 'codeberg.org';
const code_challenge_method = 'plain';

(() => {

const uSerialPromises = (inputData) => {
	return inputData.reduce(async function (coll, e) {
		return (await coll).concat(await new Promise(function (res, rej) {
			try {
				res(e());
			} catch (error) {
				rej(error);
			}
		}));
	}, Promise.resolve([]));
};

const uRandomString = (length) => {
	const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	let result = '';
	for (let i = 0; i < length; i++) {
		result += charset.charAt(Math.floor(Math.random() * charset.length));
	}
	return result;
};

const uSHA256 = async (message) => {
	const msgBuffer = new TextEncoder().encode(message); // Encode as (UTF-8)
	const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); // Hash the message
	const hashArray = Array.from(new Uint8Array(hashBuffer)); // Convert buffer to byte array
	const hashBase64 = btoa(String.fromCharCode(...hashArray)); // Convert bytes to base64
	return hashBase64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); // Base64url encode
};

const uURL = (base, parameters) => {
	const url = new URL(base);
	Object.keys(parameters).forEach(key => url.searchParams.append(key, parameters[key]));
	return url.toString();
};

const uClearContainer = (element) => {
	while (element.firstChild) {
		element.removeChild(element.firstChild);
	}
};

const _storagePath = 'data.json';
let _storageData;

const mod = {

	// COMMANDS

	async generateAuthURL () {
		const code_verifier = uRandomString(128);
		const code_challenge = await uSHA256(code_verifier);

		const params = {
			client_id: _storageData.client_id,
			redirect_uri,
			response_type: 'code',
			code_challenge_method,
			code_challenge,
			state: code_challenge,
		};

		const authorizationURL = uURL(`https://${ forgejoDomain }/login/oauth/authorize`, params);

		document.getElementById('1-link').appendChild(Object.assign(document.createElement('a'), {
			href: authorizationURL,
			textContent: authorizationURL,
		}));

		document.getElementById('1-link').appendChild(Object.assign(document.createElement('pre'), {
			textContent: JSON.stringify(params, null, ' '),
		}));
	},
 
	async generateTokenRequest (code) {
		const url = `https://${ forgejoDomain }/login/oauth/access_token`;

		const data = {
			client_id: _storageData.client_id,
			code,
			grant_type: 'authorization_code',
			redirect_uri,
			// code_challenge_method,
			code_verifier: (new URLSearchParams(location.search)).get('state'),
		};

		document.getElementById('2-post').appendChild(Object.assign(document.createElement('span'), {
			textContent: 'POST ' + url,
		}));

		document.getElementById('2-post').appendChild(Object.assign(document.createElement('pre'), {
			textContent: JSON.stringify(data, null, ' '),
		}));

		document.getElementById('2-post').appendChild(Object.assign(document.createElement('button'), {
			textContent: 'clear state',
			onclick: () => window.location.href = redirect_uri,
		}));

		document.getElementById('2-post').appendChild(Object.assign(document.createElement('pre'), {
			textContent: JSON.stringify(await (await fetch(url, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})).json(), null, ' '),
		}));

		// .then(response => {
		// 	console.log(response);
		// 	if (!response.ok) {
		// 		throw new Error('Network response was not ok ' + response.statusText);
		// 	}
		// 	return response.json();
		// });
	},

	// DATA

	_dataSave () {
		return mod.storage.storeFile('application/json', _storagePath, JSON.stringify(_storageData));
	},

	dataSet (key, value) {
		_storageData[key] = value;
		return mod._dataSave();
	},

	dataHandleSync (event) {
		if (['remote', 'conflict'].includes(event.origin)) {
			_storageData = event.newValue;
		}
	},

	// SETUP

	async setupData () {
		_storageData = await mod.storage.getObject(_storagePath);

		if (_storageData) {
			return;
		}

		_storageData = {};
		
		mod._dataSave();
	},

	setupRedirect () {
		document.getElementById('0-config').textContent = redirect_uri;
	},

	_setupClientIDForm () {
		const onsubmit = () => {
			mod.dataSet('client_id', input.value);

			uClearContainer(document.getElementById('1-link'));

			mod.setupClientID();
		};

		const form = document.createElement('form');
		const input = document.createElement('input');

		document.getElementById('1-link').appendChild(Object.assign(form, {
			onsubmit,
		}));

		form.appendChild(Object.assign(input, {
			placeholder: 'client_id',
			autofocus: true,
		}));

		form.appendChild(Object.assign(document.createElement('button'), {
			textContent: 'Save Client ID',
			onclick: onsubmit,
		}));
	},

	setupClientID () {
		if (!_storageData.client_id) {
			return mod._setupClientIDForm();
		}

		document.getElementById('1-link').appendChild(Object.assign(document.createElement('pre'), {
			textContent: 'client_id ' + _storageData.client_id,
		}));

		document.getElementById('1-link').appendChild(Object.assign(document.createElement('button'), {
			textContent: 'Clear Client ID',
			classList: 'block',
			onclick () {
				mod.dataSet('client_id', undefined);

				uClearContainer(document.getElementById('1-link'));
				
				mod.setupClientID();
			},
		}));

		if ((new URLSearchParams(location.search)).get('code')) {
			return;
		}

		return mod.generateAuthURL();
	},

	setupOauth () {
		const code = (new URLSearchParams(location.search)).get('code');
		
		if (!code) {
			return;
		}

		return mod.generateTokenRequest(code);	
	},

	// LIFECYCLE

	LifecycleDidLoad() {
		const remoteStorage = new RemoteStorage();

		const widget = new Widget(remoteStorage);
		widget.attach();

		const directory = 'ca.rosano.far';
		const scope = `/${ directory }/`;
		remoteStorage.access.claim(directory, 'rw');
		remoteStorage.caching.enable(scope);
		mod.storage = remoteStorage.scope(scope);

		remoteStorage.on('error', (error) => {
			console.error('Error occurred:', error);
		});

		remoteStorage.on('connected', () => {
			console.log('Connected to RemoteStorage');
		});

		remoteStorage.on('disconnected', () => {
			console.log('Disconnected from RemoteStorage');
		});

		mod.storage.on('change', mod.dataHandleSync);

		remoteStorage.on('ready', mod.LifecycleStorageDidInitialize);
	},

	LifecycleStorageDidInitialize () {
		return uSerialPromises(Object.keys(mod).filter(e => e.match(/^setup/)).map(e => mod[e]));
	},

};

mod.LifecycleDidLoad();

})();
</script>

<hr>

<p><small><a href="https://github.com/rosano/far/">source code</a></small></p>

</body>
</html>
